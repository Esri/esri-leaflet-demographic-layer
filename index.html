<!DOCTYPE html>
<html>
  <head>
    <title>Esri Leaflet Debug</title>

    <!-- Load Leaflet from their CDN -->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet-src.js"></script>

    <link rel="stylesheet" href="esri-leaflet-legend.css" />
    <script src="esri-leaflet-demographics.js"></script>
    <script src="usa.js"></script>

    <!-- Make the map fill the entire page -->
    <style>
      html, body, #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>

  </head>
  <body>
    <div id="map"></div>
    <script>
      var clientID = 'FxeCTSwkrA9yqVGS',
          accessToken,
          callbacks = [];

      // this function will open a window and start the oauth process
      function oauth(callback) {
        if(accessToken){
          callback(accessToken);
        } else {
          callbacks.push(callback);
          window.open("https://www.arcgis.com/sharing/oauth2/authorize?client_id="+clientID+"&response_type=token&expiration=20160&redirect_uri=http%3A%2F%2Fesri.github.io%2Fesri-leaflet-demographic-layer%2Fcallback.html", "oauth-window", "height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes");
        }
      }

      // this function will be called when the oauth process is complete
      window.oauthCallback = function(token) {
        accessToken = token;
        var callback;
        while(callback = callbacks.pop()){
          callback(token);
        }
      }

      function createPopup(latlng, properties){
        var template = "<small>{description}: <strong>{value}</strong></small><br>";
        var content = "";
        for (var key in properties){
          if(properties.hasOwnProperty(key)){
            if(properties[key].description, properties[key].value){
              content += L.Util.template(template, {
                description: properties[key].description,
                value: properties[key].value
              });
            }
          }
        }
        return L.popup().setLatLng(latlng).setContent(content);
      }

      var map = new L.Map("map").setView([41.05035951931887, -75.0146484375], 7);

      // add an OpenStreetMap tile layer
      var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      var income = new L.esri.Demographics.DemographicLayer("USAHealthCareSpending", {
        opacity: 0.75
      }).addTo(map);

      // the event authenticationrequired will fire when you need to provide a token.
      income.on('authenticationrequired', function (e) {
        // run our oauth function, when its done we will get a token
        oauth(function(token){
          // pass our new token to the retry method to retry the request(s) with the new authentication
          e.retry(token);
        });
      });

      var legend = new L.esri.Demographics.Legend("USAHealthCareSpending").addTo(map);

      legend.on('authenticationrequired', function (e) {
        // run our oauth function, when its done we will get a token
        oauth(function(token){
          // pass our new token to the retry method to retry the request(s) with the new authentication
          e.retry(token);
        });
      });

      var outline;

      map.on("click", function(e) {
        income.query(e.latlng, function(response){
          if(outline){
            map.removeLayer(outline);
          }

          outline = new L.GeoJSON(response.features[0], {
            style: function(feature){
              return {
                color: "#fff",
                weight:  3,
                opacity: 0.75
              }
            }
          }).addTo(map);

          createPopup(e.latlng, response.features[0].properties).openOn(map);
        });
      });
    </script>
  </body>
</html>